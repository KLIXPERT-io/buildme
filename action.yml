name: 'Build Projects'
description: 'Automatically builds projects with .buildme files'
author: 'Florian Narr - KLIXPERT.io'
inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '18'
runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ inputs.node-version }}
        
    - name: Find and build projects
      shell: bash
      run: |
        echo "ğŸ” Searching for .buildme files..."
        BUILDME_FILES=$(find . -name ".buildme" -not -path "*/node_modules/*" -not -path "*/\.*")
        
        if [ -z "$BUILDME_FILES" ]; then
          echo "â„¹ï¸ No .buildme files found."
          exit 0
        fi
        
        echo "ğŸ” Found .buildme files:"
        echo "$BUILDME_FILES"
        
        for FILE in $BUILDME_FILES; do
          DIR=$(dirname "$FILE")
          echo "ğŸ“‚ Processing directory: $DIR"
          
          if [ -f "$DIR/package.json" ]; then
            echo "ğŸ“¦ Found package.json in $DIR"
            echo "ğŸ”§ Installing dependencies..."
            cd "$DIR"
            npm install
            
            echo "ğŸ—ï¸ Building project..."
            npm run build
            
            echo "ğŸ§¹ Cleaning up node_modules..."
            rm -rf node_modules
            
            # Return to the original directory
            cd - > /dev/null
            
            echo "âœ… Completed building $DIR"
          else
            echo "âš ï¸ No package.json found in $DIR, skipping."
          fi
        done
        
        echo "ğŸ‰ Build process completed!"